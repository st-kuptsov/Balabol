# Balabol

**Balabol** — Telegram-бот для автоматического реагирования на сообщения по заданным правилам.
Он принимает текстовые сообщения, проверяет их по регулярным выражениям и отвечает заранее заданными ответами. Поддерживаются Prometheus-метрики и логирование.

---

## Функционал
- Прием сообщений в Telegram и их обработка.
- Очистка текста от лишних символов и дубликатов.
- Совпадение текста с правилами (first_last — проверка первого и последнего слова, all — проверка всего текста).
- Отправка ответов в Telegram.
- Метрики Prometheus (uptime, количество сообщений, совпадений правил, ошибки).
- Автоматическое обновление конфигурации на лету.
- Graceful shutdown.
- Логирование с уровнями debug/info/warn/error.

## Установка и запуск
### 1. Подготовьте конфигурацию
В каталоге config/ создайте два файла:
- **config.yaml** — настройки правил, логирования, режима работы бота и порта сервиса.
- **secrets.yaml** — секреты (токен Telegram).

Примеры:
- [`config/config.example.yaml`](config/config.example.yaml)
- [`config/secrets.example.yaml`](config/secrets.example.yaml)

### 2. Сборка и запуск через Docker

Сборка и запуск автоматизированы в скрипте `builder.sh`.

```bash
./builder.sh
```
Скрипт:
- получает текущую версию приложения (тег git или hash коммита),
- пересобирает Docker-образ,
- поднимает контейнер через docker-compose.

### 3. Docker Compose

Файл docker/docker-compose.yaml запускает сервис:
- публикует порт 9090 для Prometheus-метрик,
- монтирует директории config/ и logs/ из проекта в контейнер,
- задаёт таймзону контейнера через TZ.

### 4. Проверка работы

Приложение запускается внутри контейнера:
```bash
docker ps
```

Логи доступны по пути logs/app.log или через Docker:
```bash
docker logs -f balabol
```

---

## Метрики Prometheus

Балабол экспортирует метрики Prometheus для мониторинга работы бота и обработки сообщений.

### Метрики сообщений

| Метрика                                   | Тип       | Лейблы    | Описание                                                 |
|-------------------------------------------|-----------|-----------|----------------------------------------------------------|
| `bot_messages_total`                      | Counter   | `chat_id` | Количество полученных сообщений ботом по каждому чату.   |
| `bot_replies_total`                       | Counter   | -         | Общее количество ответов, отправленных ботом.            |
| `bot_messages_no_match_total`             | Counter   | -         | Количество сообщений, для которых не найдено совпадений. |
| `bot_errors_total`                        | Counter   | `stage`   | Количество ошибок на разных стадиях обработки сообщений. |
| `bot_rule_hits_total`                     | Counter   | `rule`    | Количество срабатываний каждого правила.                 |
| `bot_message_processing_duration_seconds` | Histogram | -         | Время обработки одного сообщения в секундах.             |

### Метрики конфигурации

| Метрика                              | Тип     | Лейблы | Описание                                   |
|--------------------------------------|---------|--------|--------------------------------------------|
| `bot_config_reload_duration_seconds` | Gauge   | -      | Время, затраченное на reload конфигурации. |
| `bot_config_reload_total`            | Counter | -      | Количество успешных reload конфигурации.   |
| `bot_config_reload_errors_total`     | Counter | -      | Количество ошибок при reload конфигурации. |

### Примечания

- Метрики с лейблами (`chat_id`, `rule`, `stage`) позволяют фильтровать данные по конкретному чату, правилу или стадии обработки.
- `bot_message_processing_duration_seconds` помогает отслеживать задержки и производительность обработки сообщений.
- Метрики конфигурации позволяют мониторить успешность и время обновления конфига без перезапуска сервиса.

---

## Логирование
Примеры сообщений:
```text
INFO  starting Balabol
DEBUG initializing metrics server
INFO  metrics server started port=9090
DEBUG initializing telegram bot
INFO  telegram bot initialized
INFO  config reloaded
```
- Все сообщения логируются через zap SugaredLogger.
- Стиль сообщений — строчные буквы, короткие описательные фразы.
- Используются уровни: debug, info, warn, error.

---

### Обновление конфигурации на лету
- Конфигурация хранится в config/config.yaml и config/secrets.yaml.
- Приложение проверяет хэши файлов каждые 5 секунд.
- При изменении файла конфигурация автоматически перечитывается.
- Логирование успешного обновления:
```bash
INFO   config reloaded
```
⚠️ При некорректной структуре конфигурации приложение продолжает работу со старой конфигурацией и выводит ошибку в лог.

---

## Graceful shutdown
- Канал `stop chan os.Signal` используется для корректного завершения всех фоновых горутин.
- Планировщик и HTTP-сервер останавливаются при получении сигнала SIGINT или SIGTERM.

---

## Пример workflow
- Пользователь пишет сообщение в Telegram.
- Бот получает текст и очищает его от лишних символов и повторов.
- Проверяются правила (режим first_last или all).
- Если совпадает правило, бот отвечает заранее заданным текстом.
- Если нет совпадений, бот не отправляет ответ.
- Метрики Prometheus обновляются.
- Логи пишутся на консоль и могут использоваться для мониторинга.

---

## Лицензия

Проект распространяется под лицензией [MIT](./LICENSE).  
Для удобства доступен [неофициальный перевод на русский язык](./LICENSE.RU.md).
